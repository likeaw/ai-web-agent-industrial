warning: in the working copy of 'backend/src/agent/DecisionMaker.py', LF will be replaced by CRLF the next time Git touches it
[1mdiff --cc backend/src/agent/DecisionMaker.py[m
[1mindex 04aec7f,f2bc57b..0000000[m
[1m--- a/backend/src/agent/DecisionMaker.py[m
[1m+++ b/backend/src/agent/DecisionMaker.py[m
[36m@@@ -1,536 -1,536 +1,553 @@@[m
[31m- # æ–‡ä»¶: backend/src/agent/DecisionMaker.py[m
[31m- [m
[31m- import os[m
[31m- import sys[m
[31m- import tempfile[m
[31m- import time[m
[31m- import uuid[m
[31m- from typing import Optional[m
[31m- from dotenv import load_dotenv[m
[31m- [m
[31m- # --- æ ¸å¿ƒæ¨¡å—å¼•å…¥ ---[m
[31m- from backend.src.agent.Planner import DynamicExecutionGraph[m
[31m- from backend.src.services.LLMAdapter import LLMAdapter[m
[31m- from backend.src.visualization.VisualizationAdapter import VisualizationAdapter[m
[31m- [m
[31m- # å·¥å…·å±‚ï¼ˆæœ¬åœ°å·¥å…·ï¼‰[m
[31m- from backend.src.tools.local_tools import launch_notepad[m
[31m- # è·¯å¾„ä¸ä¸´æ—¶æ–‡ä»¶ç®¡ç†[m
[31m- from backend.src.utils.path_utils import build_temp_file_path[m
[31m- # å¼•å…¥çœŸå®æµè§ˆå™¨æœåŠ¡[m
[31m- from backend.src.services.BrowserService import BrowserService[m
[31m- [m
[31m- # --- æ•°æ®æ¨¡å‹ ---[m
[31m- from backend.src.data_models.decision_engine.decision_models import ([m
[31m-     TaskGoal, WebObservation, ExecutionNode, ExecutionNodeStatus, DecisionAction, ActionFeedback[m
[31m- )[m
[31m- [m
[31m- # åŠ è½½ç¯å¢ƒå˜é‡ (ç¡®ä¿åœ¨ä»»ä½•é€»è¾‘æ‰§è¡Œå‰åŠ è½½)[m
[31m- load_dotenv()[m
[31m- [m
[31m- class DecisionMaker:[m
[31m-     """[m
[31m-     å†³ç­–æ‰§è¡Œè€… (DecisionMaker) - å·¥ä¸šçº§å®ç°[m
[31m-     [m
[31m-     èŒè´£ï¼š[m
[31m-     1. ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šè´Ÿè´£ BrowserService çš„åˆå§‹åŒ–ä¸å®‰å…¨é”€æ¯ã€‚[m
[31m-     2. æ‰§è¡Œæµç¼–æ’ï¼šé©±åŠ¨ Planner è¿›è¡ŒèŠ‚ç‚¹æµè½¬ã€‚[m
[31m-     3. å¼‚å¸¸ç†”æ–­ï¼šåœ¨å…³é”®è·¯å¾„å¤±è´¥æ—¶æ‰§è¡Œå‰ªææˆ–ç»ˆæ­¢ç­–ç•¥ã€‚[m
[31m-     4. å¯è§†åŒ–å®¡è®¡ï¼šåœ¨æ¯ä¸€æ­¥æ“ä½œåç”ŸæˆçŠ¶æ€å¿«ç…§ã€‚[m
[31m-     """[m
[31m- [m
[31m-     def __init__(self, task_goal: TaskGoal, headless: bool = True):[m
[31m-         """[m
[31m-         åˆå§‹åŒ–å†³ç­–å¼•æ“ã€‚[m
[31m-         [m
[31m-         :param task_goal: ä»»åŠ¡ç›®æ ‡å¯¹è±¡ã€‚[m
[31m-         :param headless: æµè§ˆå™¨è¿è¡Œæ¨¡å¼ã€‚ç”Ÿäº§ç¯å¢ƒé€šå¸¸ä¸º Trueï¼Œè°ƒè¯•ç¯å¢ƒå¯é…ç½®ä¸º Falseã€‚[m
[31m-         """[m
[31m-         self.task_goal = task_goal[m
[31m-         self.headless = headless[m
[31m-         [m
[31m-         # åˆå§‹åŒ–ç»„ä»¶[m
[31m-         self.planner = DynamicExecutionGraph()[m
[31m-         self.browser_service: Optional[BrowserService] = None[m
[31m-         [m
[31m-         # è¿è¡Œæ—¶çŠ¶æ€[m
[31m-         self.is_running = False[m
[31m-         self.current_node: Optional[ExecutionNode] = None[m
[31m-         self.execution_counter = 0 [m
[31m- [m
[31m-     def _init_browser(self):[m
[31m-         """å»¶è¿Ÿåˆå§‹åŒ–æµè§ˆå™¨èµ„æºï¼Œä»…åœ¨ run å¼€å§‹æ—¶è°ƒç”¨ã€‚"""[m
[31m-         if not self.browser_service:[m
[31m-             try:[m
[31m-                 print(f"--- [System] Initializing BrowserService (Headless: {self.headless}) ---")[m
[31m-                 self.browser_service = BrowserService(headless=self.headless)[m
[31m-             except Exception as e:[m
[31m-                 print(f"!!! [CRITICAL] Failed to initialize BrowserService: {e}")[m
[31m-                 raise RuntimeError("Browser initialization failed.") from e[m
[31m- [m
[31m-     def close(self):[m
[31m-         """èµ„æºæ¸…ç†é’©å­ï¼Œç¡®ä¿æµè§ˆå™¨è¿›ç¨‹ä¸æ®‹ç•™ã€‚"""[m
[31m-         if self.browser_service:[m
[31m-             print("--- [System] Closing BrowserService ---")[m
[31m-             try:[m
[31m-                 self.browser_service.close()[m
[31m-             except Exception as e:[m
[31m-                 print(f"[WARN] Error during browser closure: {e}")[m
[31m-             finally:[m
[31m-                 self.browser_service = None[m
[31m- [m
[31m-     def _execute_action(self, action: DecisionAction) -> WebObservation:[m
[31m-         """[m
[31m-         æ‰§è¡ŒåŸå­æ“ä½œã€‚[m
[31m-         """[m
[31m-         self.execution_counter += 1[m
[31m-         # ç»“æ„åŒ–æ—¥å¿—[m
[31m-         print(f"\n>>> [STEP {self.execution_counter}] Executing Tool: [{action.tool_name}]")[m
[31m-         try:[m
[31m-             # 1. çº¯æœ¬åœ°å·¥å…·ï¼šä¸éœ€è¦æµè§ˆå™¨ï¼ˆå¦‚ open_notepadï¼‰[m
[31m-             if action.tool_name == "open_notepad":[m
[31m-                 file_path = action.tool_args.get("file_path")[m
[31m-                 initial_content = action.tool_args.get("initial_content", "")[m
[31m- [m
[31m-                 # ç»Ÿä¸€è·å–â€œæœ€è¿‘ä¸€æ¬¡æå–ç»“æœâ€çš„æ–‡æœ¬å½¢å¼ï¼ˆæ¯è¡Œä¸€ä¸ªæ ‡é¢˜ï¼‰[m
[31m-                 titles_text: Optional[str] = None[m
[31m-                 if hasattr(self.planner, "nodes_execution_order"):[m
[31m-                     from ast import literal_eval[m
[31m- [m
[31m-                     for nid in reversed(self.planner.nodes_execution_order):[m
[31m-                         node = self.planner.nodes.get(nid)[m
[31m-                         if not node:[m
[31m-                             continue[m
[31m-                         if getattr(node, "resolved_output", None):[m
[31m-                             raw_output = str(node.resolved_output)[m
[31m-                             if raw_output.startswith("Extracted") and ":" in raw_output:[m
[31m-                                 try:[m
[31m-                                     list_part = raw_output.split(":", 1)[1].strip()[m
[31m-                                     titles = literal_eval(list_part)[m
[31m-                                     if isinstance(titles, list) and titles:[m
[31m-                                         titles_text = "\n".join(str(t) for t in titles)[m
[31m-                                     else:[m
[31m-                                         titles_text = raw_output[m
[31m-                                 except Exception:[m
[31m-                                     titles_text = raw_output[m
[31m-                             else:[m
[31m-                                 titles_text = raw_output[m
[31m-                             print(f"[LOCAL TOOL] Found resolved_output from node {nid} for notepad content.")[m
[31m-                             break[m
[31m- [m
[31m-                 # é€»è¾‘ç®€åŒ–ï¼šä¸€æ—¦æœ‰æå–ç»“æœï¼Œå°±å®Œå…¨è¦†ç›– initial_contentï¼Œé¿å…å ä½ç¬¦æ®‹ç•™[m
[31m-                 if titles_text:[m
[31m-                     initial_content = titles_text[m
[31m- [m
[31m-                 # ç»Ÿä¸€ï¼šæ‰€æœ‰è®°äº‹æœ¬ç±»ä¸´æ—¶æ–‡ä»¶å†™å…¥åˆ°é¡¹ç›®æ ¹ç›®å½• temp/notes ä¸‹ï¼ŒæŒ‰ä»»åŠ¡ä¸»é¢˜+æ—¶é—´å‘½å[m
[31m-                 if not file_path:[m
[31m-                     file_path = build_temp_file_path([m
[31m-                         file_type="notes",[m
[31m-                         task_topic=self.task_goal.target_description,[m
[31m-                         extension=".txt",[m
[31m-                     )[m
[31m- [m
[31m-                 target_path, ok, msg = launch_notepad(file_path, initial_content)[m
[31m- [m
[31m-                 fb = ActionFeedback([m
[31m-                     status="SUCCESS" if ok else "FAILED",[m
[31m-                     error_code="0" if ok else "NOTEPAD_LAUNCH_ERROR",[m
[31m-                     message=msg,[m
[31m-                 )[m
[31m- [m
[31m-                 observation = WebObservation([m
[31m-                     observation_timestamp_utc=time.strftime("%Y-%m-%dT%H:%M:%S"),[m
[31m-                     current_url="local://notepad",[m
[31m-                     http_status_code=200 if fb.status == "SUCCESS" else 500,[m
[31m-                     page_load_time_ms=0,[m
[31m-                     is_authenticated=False,[m
[31m-                     key_elements=[],[m
[31m-                     screenshot_available=False,[m
[31m-                     last_action_feedback=fb,[m
[31m-                     memory_context="Local tool execution (open_notepad).",[m
[31m-                 )[m
[31m- [m
[31m-             else:[m
[31m-                 # 2. éœ€è¦æµè§ˆå™¨çš„å·¥å…·ï¼šæŒ‰éœ€å»¶è¿Ÿåˆå§‹åŒ– BrowserService[m
[31m-                 if not self.browser_service:[m
[31m-                     self._init_browser()[m
[31m- [m
[31m-                 observation = self.browser_service.execute_action(action)[m
[31m- [m
[31m-             # ç®€å•çš„ç»“æœæ‘˜è¦[m
[31m-             fb = observation.last_action_feedback[m
[31m-             status_icon = "âœ…" if fb and fb.status == "SUCCESS" else "âŒ"[m
[31m-             print([m
[31m-                 f"    {status_icon} Result: {fb.status if fb else 'NO FEEDBACK'} | "[m
[31m-                 f"HTTP: {observation.http_status_code} | URL: {observation.current_url}"[m
[31m-             )[m
[31m- [m
[31m-             if fb and fb.status == "FAILED":[m
[31m-                 print(f"    âš ï¸ Error Details: {fb.message}")[m
[31m- [m
[31m-             return observation[m
[31m- [m
[31m-         except Exception as e:[m
[31m-             print(f"!!! [CRITICAL] Unhandled Exception in Action Execution: {e}")[m
[31m-             # è¿”å›å…œåº•çš„å¤±è´¥è§‚æµ‹ï¼Œé˜²æ­¢ç¨‹åºå´©æºƒï¼Œå…è®¸ Planner å°è¯•æ¢å¤[m
[31m-             return WebObservation([m
[31m-                 observation_timestamp_utc=time.strftime("%Y-%m-%dT%H:%M:%S"),[m
[31m-                 current_url="unknown",[m
[31m-                 http_status_code=500,[m
[31m-                 page_load_time_ms=0,[m
[31m-                 is_authenticated=False,[m
[31m-                 key_elements=[],[m
[31m-                 screenshot_available=False,[m
[31m-                 memory_context="System Critical Failure",[m
[31m-                 last_action_feedback=ActionFeedback([m
[31m-                     status="FAILED", error_code="SYSTEM_EXCEPTION", message=str(e)[m
[31m-                 ),[m
[31m-             )[m
[31m- [m
[31m-     def _handle_execution_result(self, node: ExecutionNode, observation: WebObservation) -> bool:[m
[31m-         """[m
[31m-         å¤„ç†æ‰§è¡Œç»“æœï¼šæˆåŠŸåˆ™ç»§ç»­ï¼Œå¤±è´¥åˆ™è§¦å‘ LLM åŠ¨æ€é‡è§„åˆ’ (Self-Correction)ã€‚[m
[31m-         """[m
[31m-         # [ä¿®æ”¹ç‚¹ 1] ç›´æ¥èµ‹å€¼ï¼Œç°åœ¨ ExecutionNode ä¸­å·²åŒ…å« last_observation å­—æ®µ[m
[31m-         node.last_observation = observation # å­˜å‚¨æœ€æ–°çš„è§‚æµ‹ï¼Œç”¨äºå¯è§†åŒ–å’Œé‡è§„åˆ’[m
[31m- [m
[31m-         feedback = observation.last_action_feedback[m
[31m-         if not feedback:[m
[31m-             # å¦‚æœæ²¡æœ‰åé¦ˆï¼Œè§†ä¸ºå¤±è´¥ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸[m
[31m-             feedback = ActionFeedback(status="FAILED", error_code="NO_FEEDBACK", message="Action execution returned no feedback.")[m
[31m- [m
[31m-         # 1. æˆåŠŸæƒ…å†µ[m
[31m-         if feedback.status == 'SUCCESS':[m
[31m-             node.current_status = ExecutionNodeStatus.SUCCESS[m
[31m-             print(f"    [PLAN] Node {node.node_id} COMPLETED. Graph updated.")[m
[31m-             return True[m
[31m-         [m
[31m-         # 2. å¤±è´¥æƒ…å†µå¤„ç†[m
[31m-         print(f"!!! [FAILURE] Node {node.node_id} failed. Reason: {feedback.message}")[m
[31m-         self.planner.prune_on_failure(node.node_id, feedback.message)[m
[31m-         [m
[31m-         # æ£€æŸ¥èŠ‚ç‚¹çš„å¤±è´¥ç­–ç•¥[m
[31m-         if node.action.on_failure_action == "STOP_TASK":[m
[31m-             print(f"!!! Strategy is STOP_TASK. Halting execution.")[m
[31m-             node.current_status = ExecutionNodeStatus.FAILED[m
[31m-             return False[m
[31m-             [m
[31m-         elif node.action.on_failure_action == "RE_EVALUATE":[m
[31m-             print(f"--- [RE-PLANNING] Initiating Dynamic Correction for Node {node.node_id} ---")[m
[31m-             [m
[31m-             # A. æ„é€ çº é”™ä¸Šä¸‹æ–‡[m
[31m-             # æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ Goalï¼Œæ˜ç¡®å‘Šè¯‰ LLM å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯[m
[31m-             correction_goal = self.task_goal.model_copy() # éœ€è¦ Pydantic çš„ copy æ–¹æ³•[m
[31m-             correction_goal.target_description = ([m
[31m-                 f"ORIGINAL GOAL: {self.task_goal.target_description}\n"[m
[31m-                 f"CONTEXT: The step '{node.action.tool_name}' FAILED.\n"[m
[31m-                 f"ERROR MESSAGE: {feedback.message}\n"[m
[31m-                 f"TASK: Generate a short corrective plan (1-3 steps) to fix this error and achieve the original goal."[m
[31m-             )[m
[31m-             [m
[31m-             # B. è°ƒç”¨ LLM ç”Ÿæˆçº é”™ç‰‡æ®µ[m
[31m-             # æ³¨æ„ï¼šä¼ å…¥å½“å‰çš„ observationï¼Œè¿™æ · LLM å¯ä»¥çœ‹åˆ°æŠ¥é”™åçš„é¡µé¢çŠ¶æ€[m
[31m-             try:[m
[31m-                 print(f"    [LLM] Requesting correction plan...")[m
[31m-                 correction_nodes = LLMAdapter.generate_nodes(correction_goal, observation)[m
[31m-                 [m
[31m-                 if correction_nodes:[m
[31m-                     # C. æ³¨å…¥æ–°è®¡åˆ’[m
[31m-                     print(f"    [PLAN] Injecting {len(correction_nodes)} correction nodes...")[m
[31m-                     self.planner.inject_correction_plan(node.node_id, correction_nodes)[m
[31m-                     return True # ç»§ç»­æ‰§è¡Œå¾ªç¯ï¼Œä¸‹æ¬¡ä¼šå–åˆ°æ–°æ³¨å…¥çš„èŠ‚ç‚¹[m
[31m-                 else:[m
[31m-                     print("    [LLM] Returned empty correction plan. Cannot recover.")[m
[31m-                     return False[m
[31m-                     [m
[31m-             except Exception as e:[m
[31m-                 print(f"    [ERROR] Re-planning failed: {e}")[m
[31m-                 return False[m
[31m-                 [m
[31m-         # é»˜è®¤å¤„ç†[m
[31m-         node.current_status = ExecutionNodeStatus.FAILED[m
[31m-         return True[m
[31m- [m
[31m-     def _save_visualization(self, suffix: str):[m
[31m-         """ç”Ÿæˆå¯è§†åŒ–å¿«ç…§"""[m
[31m-         filename = f"plan_{self.task_goal.task_uuid}_{suffix}"[m
[31m-         try:[m
[31m-             # æ¸²æŸ“å›¾[m
[31m-             output_dir = 'logs/graphs'[m
[31m-             os.makedirs(output_dir, exist_ok=True)[m
[31m-             content = VisualizationAdapter.render_graph_to_html_string(self.planner, filename)[m
[31m-             [m
[31m-             # å†™å…¥æ–‡ä»¶[m
[31m-             with open(os.path.join(output_dir, f"{filename}.html"), 'w', encoding='utf-8') as f:[m
[31m-                 f.write(content)[m
[31m-         except Exception as e:[m
[31m-             print(f"[WARN] Visualization failed: {e}")[m
[31m- [m
[31m-     def _resolve_dynamic_args(self, node: ExecutionNode) -> DecisionAction:[m
[31m-         """[m
[31m-         åŠ¨æ€å‚æ•°æ›¿æ¢æ–¹æ³•ï¼šå°† {result_of:NODE_ID} æ¨¡å¼æ›¿æ¢ä¸ºå®é™…çš„æ‰§è¡Œç»“æœã€‚[m
[31m-         æ­¤æ–¹æ³•åœ¨æ‰§è¡Œå‰è°ƒç”¨ï¼Œå¤„ç†åŠ¨æ€ä¾èµ–ã€‚[m
[31m-         """[m
[31m-         resolved_args = node.action.tool_args.copy()[m
[31m-         [m
[31m-         # éå†æ‰€æœ‰å‚æ•°ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«åŠ¨æ€å¼•ç”¨[m
[31m-         for key, value in node.action.tool_args.items():[m
[31m-             if isinstance(value, str) and value.startswith("{result_of:") and value.endswith("}"):[m
[31m-                 source_node_id = value[len("{result_of:"):-1][m
[31m-                 [m
[31m-                 # æ£€æŸ¥æºèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ä¸”å·²æ‰§è¡ŒæˆåŠŸ[m
[31m-                 source_node = self.planner.nodes.get(source_node_id)[m
[31m-                 if not source_node or source_node.current_status != ExecutionNodeStatus.SUCCESS:[m
[31m-                     raise ValueError(f"Dynamic argument source node '{source_node_id}' not found or not successful (Status: {source_node.current_status.name if source_node else 'Not Found'}).")[m
[31m-                 [m
[31m-                 # ä